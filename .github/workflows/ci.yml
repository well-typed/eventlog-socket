name: CI

on:
  push:
    branches:
      - "master"
  pull_request:

# Set the default shell on all platforms.
defaults:
  run:
    shell: sh

jobs:
  ################################################################################
  # Build
  ################################################################################
  build:
    name: |
      ${{ matrix.name
       || format(
            'Test on {0}{1}',
            ( startsWith(matrix.os, 'ubuntu-') && ( endsWith(matrix.os, '-arm') && 'Linux (aarch64)' || 'Linux (x86)' )
            ) ||
            ( startsWith(matrix.os, 'macOS-') && ( endsWith(matrix.os, '-intel') && 'macOS (x86)' || 'macOS (arm64)' )
            ),
            matrix.ghc-version && format(' with GHC {0}', matrix.ghc-version)
          )
       }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Haskell
        id: setup-haskell
        uses: haskell-actions/setup@v2
        with:
          ghc-version: ${{ matrix.ghc-version }}

      - name: ğŸ—ï¸ Build source distribution
        run: cabal sdist all

      - name: ğŸ—ï¸ Build
        run: cabal build all

      - name: ğŸ› ï¸ Setup ghc-events
        uses: ./.github/actions/setup-ghc-events
        with:
          ghc-events-version: "0.20.0.0"
          ghc-version: ${{ matrix.ghc-version }}

      - name: ğŸš€ Testing (Python test suite)
        if: ${{ runner.os == 'Linux' }}
        run: ./scripts/test-python.sh

      - name: ğŸš€ Testing (Haskell test suite)
        run: ./scripts/test-haskell.sh

      - name: ğŸ“¦ Upload test logs
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: eventlog-socket-tests-${{ runner.os }}-${{ runner.arch }}-ghc-${{ matrix.ghc-version }}.log
          path: eventlog-socket-tests.log

    strategy:
      fail-fast: false
      matrix:
        os:
          - "ubuntu-latest"
        ghc-version:
          - "9.2.8"
          - "9.4.8"
          - "9.6.7"
          - "9.8.4"
          - "9.10.2"
          - "9.12.2"
        include:
          # Include single ubuntu/arm64 runner:
          - os: "ubuntu-24.04-arm"
            ghc-version: "9.10.2"
          # Include single macOS/x86 runner:
          - os: "macOS-15-intel"
            ghc-version: "9.10.2"
          # Include single macOS/arm64 runner:
          - os: "macOS-latest"
            ghc-version: "9.10.2"

  #############################################################################
  # Lint with actionlint
  #############################################################################

  lint-actionlint:
    name: "Lint with actionlint"
    runs-on: "ubuntu-latest"
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: ğŸ—„ï¸ Read dev-dependencies
        run: cat "./scripts/dev-dependencies.txt" >> "$GITHUB_OUTPUT"
        id: dev-dependencies

      - name: "Setup actionlint"
        uses: ./.github/actions/setup-actionlint
        with:
          actionlint-version: ${{ steps.dev-dependencies.outputs.actionlint }}

      - name: ğŸ—ï¸ Lint with actionlint
        run: ./scripts/lint-actionlint.sh

  #############################################################################
  # Lint with cabal
  #############################################################################

  lint-cabal:
    name: "Lint with Cabal"
    runs-on: "ubuntu-latest"
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: ğŸ—„ï¸ Read dev-dependencies
        run: cat "./scripts/dev-dependencies.txt" >> "$GITHUB_OUTPUT"
        id: dev-dependencies

      - name: ğŸ› ï¸ Install Haskell
        uses: haskell-actions/setup@v2
        with:
          ghc-version: ${{ steps.dev-dependencies.outputs.ghc }}
          cabal-version: ${{ steps.dev-dependencies.outputs.cabal }}
        id: setup-haskell

      - name: ğŸ—ï¸ Lint with Cabal
        run: ./scripts/lint-cabal.sh

  #############################################################################
  # Lint with cabal-fmt
  #############################################################################

  lint-cabal-fmt:
    name: "Lint with cabal-fmt"
    runs-on: "ubuntu-latest"
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: ğŸ—„ï¸ Read dev-dependencies
        run: cat "./scripts/dev-dependencies.txt" >> "$GITHUB_OUTPUT"
        id: dev-dependencies

      - name: ğŸ› ï¸ Install cabal-fmt
        uses: ./.github/actions/setup-cabal-fmt
        with:
          cabal-fmt-version: ${{ steps.dev-dependencies.outputs.cabal-fmt }}
          ghc-version: ${{ steps.dev-dependencies.outputs.ghc }}
          cabal-version: ${{ steps.dev-dependencies.outputs.cabal }}

      - name: ğŸ—ï¸ Lint with cabal-fmt
        run: ./scripts/lint-cabal-fmt.sh

  #############################################################################
  # Lint with clang-format
  #############################################################################

  lint-clang-format:
    name: "Lint with clang-format"
    runs-on: "ubuntu-latest"
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: ğŸ—„ï¸ Read dev-dependencies
        run: cat "./scripts/dev-dependencies.txt" >> "$GITHUB_OUTPUT"
        id: dev-dependencies

      - name: ğŸ—ï¸ Lint with clang-format
        uses: jidicula/clang-format-action@v4.16.0
        with:
          clang-format-version: ${{ steps.dev-dependencies.outputs.clang-format }}

  #############################################################################
  # Lint with Fourmolu
  #############################################################################

  lint-fourmolu:
    name: "Lint with Fourmolu"
    runs-on: "ubuntu-latest"
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: ğŸ—„ï¸ Read dev-dependencies
        run: cat "./scripts/dev-dependencies.txt" >> "$GITHUB_OUTPUT"
        id: dev-dependencies

      - name: ğŸ› ï¸ Install Fourmolu
        uses: ./.github/actions/setup-fourmolu
        with:
          fourmolu-version: ${{ steps.dev-dependencies.outputs.fourmolu }}
          ghc-version: ${{ steps.dev-dependencies.outputs.ghc }}
          cabal-version: ${{ steps.dev-dependencies.outputs.cabal }}

      - name: ğŸ—ï¸ Lint with Fourmolu
        run: ./scripts/lint-fourmolu.sh

  #############################################################################
  # Lint with pyright
  #############################################################################

  lint-pyright:
    name: "Lint with pyright"
    runs-on: "ubuntu-latest"
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: ğŸ—ï¸ Lint with pyright
        uses: jakebailey/pyright-action@v2
